name: é«˜æ–‡æ–‡å¤œé–“å›žæ­¸æ¸¬è©¦

on:
  schedule:
    # æ¯æ—¥ 02:00 (Asia/Taipei) = 18:00 UTC
    - cron: '0 18 * * *'
  workflow_dispatch: # æ‰‹å‹•è§¸ç™¼

jobs:
  nightly-regression:
    name: å¤œé–“å›žæ­¸æ¸¬è©¦
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£ä¾è³´
        run: npm ci
      
      - name: é‡æ–° seed è³‡æ–™
        run: |
          npm run seed:merchants
          npm run seed:parking
      
      - name: åŸ·è¡Œè³‡æ–™é©—è­‰
        run: npm run validate:data
      
      - name: åŸ·è¡Œ API ç…™éœ§æ¸¬è©¦
        run: npm run test:api:smoke
      
      - name: åŸ·è¡Œå®Œæ•´å°è©±é©—æ”¶
        run: npm run eval:full
      
      - name: ç”¢å‡ºå¤œé–“å›žæ­¸å ±å‘Š
        run: |
          DATE=$(date +%Y-%m-%d)
          REPORT_FILE="data/eval/report/nightly-${DATE}.json"
          
          cat > "$REPORT_FILE" << EOF
          {
            "date": "${DATE}",
            "timestamp": "$(date -Iseconds)",
            "suite": "nightly",
            "environment": "production",
            "status": "PASS",
            "summary": {
              "data_validation": "PASS",
              "api_smoke_test": "PASS",
              "conversation_eval": "PASS"
            },
            "details": {
              "data_validation_report": "data/eval/report/data-validation.json",
              "api_smoke_report": "data/eval/report/api-smoke-test.json",
              "conversation_eval_report": "data/eval/report/test-report.json"
            }
          }
          EOF
      
      - name: ä¸Šå‚³å¤œé–“å›žæ­¸å ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: nightly-regression-report-${{ github.run_number }}
          path: data/eval/report/nightly-*.json
      
      - name: æª¢æŸ¥é€šéŽçŽ‡ä¸¦ç™¼é€è­¦å ±
        run: |
          PASS_RATE=$(node -e "
          const fs = require('fs');
          try {
            const report = JSON.parse(fs.readFileSync('data/eval/report/test-report.json', 'utf8'));
            console.log(report.pass_rate);
          } catch (e) {
            console.log('0');
          }
          ")
          
          if (( $(echo "$PASS_RATE < 95" | bc -l) )); then
            echo "ðŸš¨ è­¦å ±: é€šéŽçŽ‡ä½Žæ–¼ 95% ($PASS_RATE%)"
            echo "ðŸ“§ ç™¼é€è­¦å ±é€šçŸ¥..."
            # é€™è£¡å¯ä»¥åŠ å…¥å¯¦éš›çš„è­¦å ±ç™¼é€é‚è¼¯
            # ä¾‹å¦‚: curl -X POST "https://hooks.slack.com/..." -d "{\"text\":\"é«˜æ–‡æ–‡å¤œé–“å›žæ­¸å¤±æ•—: é€šéŽçŽ‡ $PASS_RATE%\"}"
            exit 1
          else
            echo "ðŸŽ‰ å¤œé–“å›žæ­¸æ¸¬è©¦å…¨éƒ¨é€šéŽï¼é€šéŽçŽ‡: $PASS_RATE%"
          fi
      
      - name: å„²å­˜æ¸¬è©¦çµæžœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-test-results-${{ github.run_number }}
          path: data/eval/report/
