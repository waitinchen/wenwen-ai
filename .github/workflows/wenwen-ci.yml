name: é«˜æ–‡æ–‡ CI é©—æ”¶æµç¨‹

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  wenwen-validation:
    name: é«˜æ–‡æ–‡é©—æ”¶æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£ä¾è³´
        run: npm ci
      
      - name: è³‡æ–™é©—è­‰
        run: npm run validate:data
      
      - name: API ç…™éœ§æ¸¬è©¦
        run: npm run test:api:smoke
      
      - name: å¿«é€Ÿå°è©±é©—æ”¶
        run: npm run eval:quick
      
      - name: å®Œæ•´å°è©±é©—æ”¶
        run: npm run eval:full
      
      - name: ä¸Šå‚³é©—æ”¶å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: wenwen-eval-reports
          path: |
            data/eval/report/
            .github/wenwen/report/
      
      - name: æ›´æ–°é«˜æ–‡æ–‡ç‹€æ…‹
        run: |
          # å»ºç«‹ç‹€æ…‹å ±å‘Š
          DATE=$(date +%Y-%m-%d)
          COMMIT_HASH=$(git rev-parse HEAD)
          SHORT_HASH=$(git rev-parse --short HEAD)
          
          # æ›´æ–° .github/wenwen/README.md ä¸­çš„ commit hash
          sed -i "s/æœ€æ–° Commit.*/æœ€æ–° Commit: \`$COMMIT_HASH\`/" .github/wenwen/README.md
          sed -i "s/æœ€å¾Œæ›´æ–°.*/æœ€å¾Œæ›´æ–°: $(date '+%Y-%m-%d %H:%M') (Asia\/Taipei)/" .github/wenwen/README.md
          
          # å»ºç«‹ç‹€æ…‹æ‘˜è¦
          cat > .github/wenwen/report/ci-status.json << EOF
          {
            "timestamp": "$(date -Iseconds)",
            "commit": "$COMMIT_HASH",
            "short_commit": "$SHORT_HASH",
            "branch": "${{ github.ref_name }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "status": "success",
            "version": "WEN 1.0.3"
          }
          EOF
      
      - name: æäº¤ç‹€æ…‹æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/wenwen/
          git diff --staged --quiet || git commit -m "ðŸ¤– æ›´æ–°é«˜æ–‡æ–‡é©—æ”¶ç‹€æ…‹ - ${{ github.sha }}"
          git push || echo "No changes to commit"

  wenwen-quality-gate:
    name: é«˜æ–‡æ–‡å“è³ªå®ˆé–€
    runs-on: ubuntu-latest
    needs: wenwen-validation
    if: always()
    
    steps:
      - name: æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: ä¸‹è¼‰é©—æ”¶å ±å‘Š
        uses: actions/download-artifact@v4
        with:
          name: wenwen-eval-reports
          path: reports/
      
      - name: æª¢æŸ¥é©—æ”¶çµæžœ
        run: |
          echo "ðŸ” æª¢æŸ¥é«˜æ–‡æ–‡é©—æ”¶çµæžœ..."
          
          # æª¢æŸ¥è³‡æ–™é©—è­‰çµæžœ
          if [ -f "reports/data/eval/report/data-validation.json" ]; then
            DATA_PASS_RATE=$(node -e "
              const fs = require('fs');
              try {
                const report = JSON.parse(fs.readFileSync('reports/data/eval/report/data-validation.json', 'utf8'));
                console.log(report.passed_files / report.total_files);
              } catch (e) {
                console.log('0');
              }
            ")
            echo "ðŸ“Š è³‡æ–™é©—è­‰é€šéŽçŽ‡: $(echo "$DATA_PASS_RATE * 100" | bc -l)%"
          fi
          
          # æª¢æŸ¥ API ç…™éœ§æ¸¬è©¦çµæžœ
          if [ -f "reports/data/eval/report/api-smoke-test.json" ]; then
            API_PASS_RATE=$(node -e "
              const fs = require('fs');
              try {
                const report = JSON.parse(fs.readFileSync('reports/data/eval/report/api-smoke-test.json', 'utf8'));
                console.log(report.passed_tests / report.total_tests);
              } catch (e) {
                console.log('0');
              }
            ")
            echo "ðŸ”¥ API ç…™éœ§æ¸¬è©¦é€šéŽçŽ‡: $(echo "$API_PASS_RATE * 100" | bc -l)%"
          fi
          
          # æª¢æŸ¥å°è©±é©—æ”¶çµæžœ
          if [ -f "reports/data/eval/report/test-report.json" ]; then
            CONV_PASS_RATE=$(node -e "
              const fs = require('fs');
              try {
                const report = JSON.parse(fs.readFileSync('reports/data/eval/report/test-report.json', 'utf8'));
                console.log(report.pass_rate);
              } catch (e) {
                console.log('0');
              }
            ")
            echo "ðŸ’¬ å°è©±é©—æ”¶é€šéŽçŽ‡: $(echo "$CONV_PASS_RATE * 100" | bc -l)%"
          fi
          
          # å“è³ªå®ˆé–€æª¢æŸ¥
          echo "ðŸšª åŸ·è¡Œå“è³ªå®ˆé–€æª¢æŸ¥..."
          
          # æª¢æŸ¥æ˜¯å¦æ‰€æœ‰æ¸¬è©¦éƒ½é€šéŽ
          if [ "${{ needs.wenwen-validation.result }}" != "success" ]; then
            echo "âŒ é«˜æ–‡æ–‡é©—æ”¶æ¸¬è©¦å¤±æ•—ï¼"
            echo "è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š"
            echo "- è³‡æ–™é©—è­‰æ˜¯å¦é€šéŽ"
            echo "- API ç…™éœ§æ¸¬è©¦æ˜¯å¦é€šéŽ"
            echo "- å°è©±é©—æ”¶æ¸¬è©¦æ˜¯å¦é€šéŽ"
            exit 1
          fi
          
          echo "âœ… é«˜æ–‡æ–‡å“è³ªå®ˆé–€æª¢æŸ¥é€šéŽï¼"
          echo "ðŸŽ‰ æ‰€æœ‰é©—æ”¶æ¸¬è©¦æˆåŠŸï¼Œå¯ä»¥åˆä½µ PR æˆ–éƒ¨ç½²ï¼"
      
      - name: å»ºç«‹å“è³ªå ±å‘Š
        run: |
          cat > .github/wenwen/report/quality-gate-report.json << EOF
          {
            "timestamp": "$(date -Iseconds)",
            "commit": "${{ github.sha }}",
            "workflow": "${{ github.workflow }}",
            "run_id": "${{ github.run_id }}",
            "status": "PASS",
            "quality_gate": "PASSED",
            "version": "WEN 1.0.3",
            "checks": {
              "data_validation": "PASS",
              "api_smoke_test": "PASS",
              "conversation_eval": "PASS",
              "build_test": "PASS"
            }
          }
          EOF
