name: é«˜æ–‡æ–‡æŒçºŒé©—æ”¶ CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  data-validation:
    name: è³‡æ–™é©—è­‰
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£ä¾è³´
        run: npm ci
      
      - name: åŸ·è¡Œè³‡æ–™é©—è­‰
        run: npm run validate:data
      
      - name: ä¸Šå‚³é©—è­‰å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: data-validation-report
          path: data/eval/report/data-validation.json

  api-smoke-test:
    name: API ç…™éœ§æ¸¬è©¦
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£ä¾è³´
        run: npm ci
      
      - name: åŸ·è¡Œ API ç…™éœ§æ¸¬è©¦
        run: npm run test:api:smoke
      
      - name: ä¸Šå‚³ API æ¸¬è©¦å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-smoke-test-report
          path: data/eval/report/api-smoke-test.json

  conversation-eval:
    name: å°è©±é©—æ”¶æ¸¬è©¦
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£ä¾è³´
        run: npm ci
      
      - name: åŸ·è¡Œå¿«é€Ÿå°è©±é©—æ”¶
        run: npm run eval:quick
      
      - name: ä¸Šå‚³å°è©±é©—æ”¶å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: conversation-eval-report
          path: data/eval/report/test-report.json

  build-test:
    name: æ§‹å»ºæ¸¬è©¦
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£ä¾è³´
        run: npm ci
      
      - name: åŸ·è¡Œ TypeScript æª¢æŸ¥
        run: npm run type-check
      
      - name: åŸ·è¡Œ ESLint æª¢æŸ¥
        run: npm run lint
      
      - name: åŸ·è¡Œæ§‹å»º
        run: npm run build
      
      - name: ä¸Šå‚³æ§‹å»ºç”¢ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/

  nightly-regression:
    name: å¤œé–“å›æ­¸æ¸¬è©¦
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      
      - name: è¨­å®š Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: å®‰è£ä¾è³´
        run: npm ci
      
      - name: åŸ·è¡Œå¤œé–“å›æ­¸æ¸¬è©¦
        run: npm run nightly
      
      - name: ä¸Šå‚³å¤œé–“å›æ­¸å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-regression-report
          path: data/eval/report/nightly-*.json
      
      - name: æª¢æŸ¥é€šéç‡
        run: |
          PASS_RATE=$(node -e "
          const fs = require('fs');
          try {
            const report = JSON.parse(fs.readFileSync('data/eval/report/test-report.json', 'utf8'));
            console.log(report.pass_rate);
          } catch (e) {
            console.log('0');
          }
          ")
          
          if (( $(echo "$PASS_RATE < 95" | bc -l) )); then
            echo "ğŸš¨ è­¦å ±: é€šéç‡ä½æ–¼ 95% ($PASS_RATE%)"
            exit 1
          else
            echo "âœ… å¤œé–“å›æ­¸æ¸¬è©¦é€šéï¼é€šéç‡: $PASS_RATE%"
          fi

  notify-failure:
    name: å¤±æ•—é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [data-validation, api-smoke-test, conversation-eval, build-test]
    if: failure()
    steps:
      - name: ç™¼é€å¤±æ•—é€šçŸ¥
        run: |
          echo "ğŸš¨ CI æª¢æŸ¥å¤±æ•—ï¼"
          echo "è«‹æª¢æŸ¥ä»¥ä¸‹å·¥ä½œæµç¨‹çš„çµæœï¼š"
          echo "- è³‡æ–™é©—è­‰: ${{ needs.data-validation.result }}"
          echo "- API ç…™éœ§æ¸¬è©¦: ${{ needs.api-smoke-test.result }}"
          echo "- å°è©±é©—æ”¶æ¸¬è©¦: ${{ needs.conversation-eval.result }}"
          echo "- æ§‹å»ºæ¸¬è©¦: ${{ needs.build-test.result }}"
