# WenWen AI 系統功能測試計畫

## 1. 測試目標
- 驗證文山特區 WenWen AI 客服系統在前台客服、後台營運、內容管理、分析報表與系統管理等核心功能上符合需求。
- 確保 Supabase Edge Functions、資料庫與前端模組化 API 之間的整合行為正確，權限控制符合安全規範。
- 提供迭代開發與回歸測試所需的測試案例基礎，支援後續自動化測試腳本撰寫。

## 2. 測試範圍
- **前台使用者體驗**：React/Vite 客服聊天頁面、快速提問、對話紀錄、LINE 使用者註冊流程。
- **管理後台**：登入與權限、儀表板、商家與活動管理、FAQ/知識庫維運、AI 人格與訓練資料設定、互動過濾、客服記錄查詢、快速提問管理、分析頁面。
- **後端服務**：Supabase Edge Functions（`claude-chat`、`admin-auth`、`admin-management`、`content-validation`、`analytics-service`、`daily-conversation-reset`）、資料庫觸發器與排程、外部 API（Claude、LINE）。
- **系統支援流程**：環境變數與金鑰管理、日誌與錯誤處理、Cloud Build/Run 部署流程。

## 3. 參考文件
- README.md、GCP_部署指南.md
- database-structure.sql
- src/lib/api/* 模組化 API 客戶端
- Supabase Edge Functions 原始碼（supabase/functions/*）

## 4. 測試策略
- **測試階段**：
  1. 單元測試（由開發撰寫，未納入本文範圍）。
  2. 功能與整合測試：以手動測試為主，輔以 Postman/Thunder Client 驗證 Edge Functions。
  3. 端對端（E2E）測試：規劃以 Playwright/Cypress 實作自動化腳本，覆蓋核心使用者旅程與回歸情境。
  4. 冒煙測試：每次部署後快速確認關鍵功能可用。
  5. 回歸測試：重大版本或資料庫調整後執行全套案例。
- **測試類型**：功能測試、權限測試、錯誤處理、資料驗證、API 整合、安全性（基礎）驗證。

## 5. 測試環境與前置作業
| 環境 | 目的 | URL / 取得方式 | 資料與設定 |
|------|------|----------------|------------|
| 本機開發 | 功能驗證、案例撰寫 | `pnpm dev` → http://localhost:5173 | `.env.local` 設定 Supabase/Sentry/Claude 測試金鑰；匯入測試資料庫快照 |
| Staging（建議） | 部署前整合測試 | Cloud Run staging 服務 | 使用專屬 Supabase 專案、服務角色金鑰儲存在 Secret Manager；Cloud Build 觸發部署 |
| Production | 部署後冒煙測試 | 產品實際網址 | 僅執行無破壞性驗證；避免寫入測試資料 |

### 5.1 測試帳號
- Supabase `admins`：建立至少三種角色（系統管理員、內容管理員、分析檢視者）。
- LINE 使用者：建立測試用 line_user_id 與對應 profile。
- Claude/外部 API：使用測試金鑰或 sandbox 模式。

### 5.2 測試資料
- 匯入 `database-structure.sql` 基礎結構。
- 另建測試資料集：商家 3 筆、FAQ 10 筆、活動 5 筆、Quick Questions 5 筆、content_warnings 規則 3 筆。

## 6. 測試角色與責任
| 角色 | 責任 |
|------|------|
| 測試負責人 (QA Lead) | 制定計畫、協調資源、審核測試結果、決定測試進入/退出條件 |
| 測試工程師 | 編寫測試案例、執行測試、回報缺陷、維護測試資料 |
| 開發工程師 | 提供功能說明、修正缺陷、支援測試工具與資料初始化 |
| 產品負責人 | 確認測試優先順序、驗收關鍵功能 |

## 7. 測試時程與里程碑
| 階段 | 週期 | 主要產出 |
|------|------|----------|
| 測試準備 | Sprint 第 1 週 | 測試計畫、環境建置、測試資料匯入 |
| 功能測試 | Sprint 第 2~3 週 | 功能案例執行結果、缺陷單 |
| 整合/E2E 測試 | Sprint 第 3 週 | 自動化腳本雛型、跨模組缺陷報告 |
| 回歸測試 | 每次發布前 | 回歸測試結果報告、釋出建議 |

## 8. 測試案例總覽
以下以模組分類列出核心功能測試案例（Priority：H=高、M=中、L=低）。實際執行時應補充詳細步驟、預期結果、測試資料與自動化腳本連結。

### 8.1 前台客服體驗（`src/components/ChatInterface.tsx` 等）
| 編號 | 測試項目 | 描述 | 類型 | 優先度 |
|------|----------|------|------|--------|
| FT-001 | 首次造訪歡迎流程 | 未登入 LINE 使用者進入頁面，顯示歡迎訊息、快速提問與登入提示 | 功能/UX | H |
| FT-002 | LINE 用戶註冊 | 模擬從 LINE 登入後呼叫 `UserAuthContext` 註冊 API，確認資料寫入 Supabase `line_users` | 整合 | H |
| FT-003 | 快速提問觸發 | 點擊快速提問按鈕，確認訊息列新增問答、呼叫 `chat.sendQuickQuestion` API | 功能 | H |
| FT-004 | 使用者輸入訊息 | 在輸入框輸入文字送出，訊息推入訊息串並呼叫 `claude-chat` Edge Function | 功能 | H |
| FT-005 | Claude 回覆顯示 | Edge Function 回傳資料後，正確顯示 AI 回覆、載入指示器消失 | 整合 | H |
| FT-006 | 對話節流與錯誤處理 | 模擬每日上限或 Edge Function 失敗情境，顯示錯誤訊息與重試行為 | 錯誤處理 | M |
| FT-007 | 歷史對話載入 | 重新整理頁面後載入相同 `chat_session` 歷史訊息 | 功能 | M |
| FT-008 | 裝置相容性 | 桌面與手機尺寸下排版與互動符合 UX 要求 | UX | M |

### 8.2 管理員認證與安全（`src/contexts/AdminAuthContext.tsx`, `supabase/functions/admin-auth`）
| 編號 | 測試項目 | 描述 | 類型 | 優先度 |
|------|----------|------|------|--------|
| AD-001 | 正常登入流程 | 使用有效帳密登入，`admin-auth/login` 回傳 token，前端儲存在 session storage 并導向儀表板 | 功能 | H |
| AD-002 | 錯誤憑證處理 | 輸入錯誤密碼，Edge Function 回傳 401，前端顯示錯誤訊息 | 錯誤處理 | H |
| AD-003 | Token 過期 | 模擬過期 token，驗證 `validateSession` 觸發登出流程並導向登入頁 | 安全 | H |
| AD-004 | 角色權限限制 | 不同角色登入時，驗證頁面與 API 權限限制（僅具備對應菜單與操作按鈕） | 功能/安全 | H |
| AD-005 | 登出流程 | 點擊登出，token 被刪除，Edge Function 記錄登出狀態 | 功能 | M |
| AD-006 | 多分頁 session 同步 | 同帳號多視窗登入與登出同步行為 | 功能 | L |

### 8.3 儀表板與分析（`AnalyticsDashboard`, `analytics-service`）
| 編號 | 測試項目 | 描述 | 類型 | 優先度 |
|------|----------|------|------|--------|
| AN-001 | 儀表板載入 | 登入後載入概覽圖表，`analytics.getSummary` 回傳正確數據 | 功能 | H |
| AN-002 | 日期篩選 | 切換日期範圍，確認 API 參數更新與圖表刷新 | 功能 | M |
| AN-003 | 下載報表 | 匯出 CSV/JSON（如有實作）成功，檔案內容正確 | 功能 | L |
| AN-004 | 無資料情境 | 當期間無資料時顯示空狀態而非錯誤 | 錯誤處理 | M |

### 8.4 知識庫與內容管理（FAQ、訓練資料、AI 人格、內容警示）
| 編號 | 測試項目 | 描述 | 類型 | 優先度 |
|------|----------|------|------|--------|
| KB-001 | FAQ 列表載入 | 呼叫 `knowledgeBase.listFaqs`，顯示分頁資料 | 功能 | H |
| KB-002 | 新增 FAQ | 透過表單新增項目，Edge Function 寫入後立即顯示於列表 | 功能 | H |
| KB-003 | 編輯/刪除 FAQ | 編輯內容、刪除項目並確認資料庫更新 | 功能 | H |
| KB-004 | 訓練資料批次匯入 | 上傳 CSV/JSON，成功寫入 `training_dataset`（如無自動化則紀錄手動流程） | 整合 | M |
| KB-005 | AI 人格切換 | 更新人格設定後，前台對話使用新提示詞 | 整合 | H |
| KB-006 | 內容警示規則 | 建立/編輯 `content_warnings`，測試聊天觸發警示顯示與 Edge Function 擋下敏感輸入 | 功能/安全 | H |

### 8.5 商家與活動營運模組（`StoreManagement`, `ActivitiesManager`, `QuickQuestionsManager`）
| 編號 | 測試項目 | 描述 | 類型 | 優先度 |
|------|----------|------|------|--------|
| OP-001 | 商家 CRUD | 新增/編輯/刪除商家資料，並在前台檢視是否同步更新 | 功能/整合 | H |
| OP-002 | 活動排程 | 新增活動含日期與狀態，確認過期活動自動隱藏或標示 | 功能 | M |
| OP-003 | 快速提問排序 | 調整排序欄位，前台快速提問順序更新 | 功能 | H |
| OP-004 | 多語/分類欄位 | 如有分類、多語欄位，確認表單驗證與顯示正確 | 功能 | L |

### 8.6 對話歷史與客服監控（`ConversationHistoryManager`, `ConversationDetails`）
| 編號 | 測試項目 | 描述 | 類型 | 優先度 |
|------|----------|------|------|--------|
| CM-001 | 對話列表篩選 | 依日期、關鍵字、標籤搜尋對話 | 功能 | M |
| CM-002 | 對話詳情 | 點擊進入詳情，顯示完整訊息串與 metadata | 功能 | M |
| CM-003 | 對話標註 | 新增/更新標註或狀態（例如已處理），資料保存成功 | 功能 | L |

### 8.7 Edge Function / API 測試
| 編號 | 測試項目 | 描述 | 類型 | 優先度 |
|------|----------|------|------|--------|
| API-001 | `claude-chat` 成功呼叫 | 送出合法 payload，接收 Claude 回應與用量資訊 | 整合 | H |
| API-002 | `claude-chat` 速率限制 | 模擬超量呼叫，確認返回錯誤碼並記錄於日誌 | 安全 | H |
| API-003 | `admin-auth` 權限保護 | 未附帶 Service Role Key 時拒絕關鍵操作 | 安全 | H |
| API-004 | `admin-management` CRUD | 驗證增刪改查 API 回應，確認 RLS 或角色檢查生效 | 功能/安全 | H |
| API-005 | `content-validation` 攔截 | 模擬觸發敏感字詞，Edge Function 回傳阻擋結果且前端顯示提示 | 功能 | H |
| API-006 | `daily-conversation-reset` 排程 | 手動觸發函式，確認每日統計重置邏輯 | 功能 | M |

### 8.8 系統支援與部署流程
| 編號 | 測試項目 | 描述 | 類型 | 優先度 |
|------|----------|------|------|--------|
| OPS-001 | `.env` 管理 | 驗證 `.env.example` 完整度，本機缺漏變數時建置失敗並顯示指引 | 配置 | M |
| OPS-002 | Cloud Build 流程 | 觸發 `gcloud builds submit`，管線依序執行 lint/type-check/build/deploy | 整合 | M |
| OPS-003 | Cloud Run 部署後冒煙 | 部署完成後執行 AD-001、FT-003 等冒煙測試 | 冒煙 | H |
| OPS-004 | 監控與日誌 | 在 Supabase/Cloud Logging 查詢邏輯錯誤與邊界條件紀錄 | 可運維性 | M |

## 9. 測試資料與工具維護
- 建議建立自動化腳本（SQL/TS）重建測試資料，確保每次回歸使用一致狀態。
- Postman collection 或 Thunder Client 匯出檔案放置於 `wenwen-ai/docs/testing` 目錄（後續建立）。
- E2E 自動化腳本版本控制於 `tests/e2e`（後續建立）。

## 10. 測試進入與退出準則
- **進入條件**：需求與設計審核完成、測試環境搭建完成、主要模組開發完畢、測試資料就緒。
- **退出條件**：所有高優先度缺陷關閉或獲得接受、回歸測試通過、產品負責人簽核、測試報告完成。

## 11. 風險與緩解
| 風險 | 影響 | 緩解措施 |
|------|------|----------|
| 測試環境與 Production 設定差異 | 功能在生產環境失效 | 建立 staging，確保環境變數與資源一致；使用基礎設施即程式碼記錄 |
| 第三方 API 限流 | 測試期間被限流導致案例失敗 | 建立測試金鑰或 mock 服務；在離線狀態下使用錄製回放 |
| 資料庫狀態不一致 | 案例依賴舊資料導致結果不準確 | 每輪回歸前重建資料庫快照或使用遷移腳本重置 |
| 自動化覆蓋率不足 | 回歸時間長、易出錯 | 優先為高風險流程撰寫 E2E 測試；建立 CI 排程定期執行 |

## 12. 測試交付成果
- 測試案例表（Spreadsheet 或 TestRail/Notion）。
- Postman/Thunder Client API 集合。
- E2E 自動化腳本與報告。
- 測試結果報告（含缺陷統計與修復狀態）。
- 回歸測試清單與執行情況紀錄。

---
本測試計畫將隨功能演進定期檢視與更新，確保覆蓋所有新模組與流程。
