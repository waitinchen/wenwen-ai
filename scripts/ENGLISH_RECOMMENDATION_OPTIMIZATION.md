# 英語推薦邏輯優化報告 - WEN 1.1.6

## 📋 優化需求

### **用戶要求**
- **首次查詢**: 英語/美語意圖時只推薦肯塔基美語一家
- **追問處理**: 用戶追問時才用關鍵字搜索商家資料庫提供更多選擇

### **優化目標**
1. 提升推薦精準度，避免推薦過多商家造成選擇困難
2. 優先推薦特約商家肯塔基美語
3. 在用戶有明確需求時才提供更多選擇

## 🔧 技術實現

### **追問檢測邏輯**
```typescript
// 檢查是否為追問（包含更多關鍵字或明確要求更多推薦）
const isFollowUpQuery = messageContent.includes('還有其他') || 
                       messageContent.includes('更多') || 
                       messageContent.includes('其他選擇') ||
                       messageContent.includes('還有嗎') ||
                       messageContent.includes('其他') ||
                       messageContent.includes('另外') ||
                       messageContent.includes('還有什麼');
```

### **推薦邏輯分支**
```typescript
if (isFollowUpQuery) {
  // 追問時：用關鍵字搜索商家資料庫
  const educationRes = await fetch(`${SUPABASE_URL}/rest/v1/stores?category=eq.教育培訓&limit=5`);
  recList = educationData; // 使用教育培訓類別的所有商家
} else {
  // 首次查詢：只推薦肯塔基美語
  const kentuckyRes = await fetch(`${SUPABASE_URL}/rest/v1/stores?store_name=eq.肯塔基美語&limit=1`);
  recList = [kentucky[0]]; // 只保留肯塔基美語
}
```

### **System Prompt 更新**
```
重要規則：
2. 英語學習查詢：首次只推薦肯塔基美語一家，除非用戶明確追問更多選擇
3. 其他查詢：提供 2-3 家相關商家推薦
```

## 📊 使用場景

### **場景 1: 首次英語學習查詢**
**用戶輸入**: "我想學英語"
**預期回應**: 只推薦肯塔基美語一家，包含詳細資訊

### **場景 2: 追問更多選擇**
**用戶輸入**: "還有其他選擇嗎？"
**預期回應**: 提供教育培訓類別的所有商家（最多5家）

### **場景 3: 其他查詢類型**
**用戶輸入**: "有什麼美食推薦？"
**預期回應**: 提供2-3家餐飲美食商家

## 🎯 優化效果

### **優點**
1. **精準推薦**: 首次查詢聚焦於最佳選擇
2. **減少選擇困難**: 避免一次性推薦過多商家
3. **特約商家優先**: 確保肯塔基美語獲得優先推薦
4. **按需擴展**: 用戶有需要時才提供更多選擇

### **用戶體驗改善**
- 首次查詢更簡潔明確
- 追問時能獲得完整資訊
- 推薦邏輯更符合用戶期望

## 🧪 測試案例

### **測試案例 1: 首次英語查詢**
```
輸入: "我想學英語"
預期: 只推薦肯塔基美語一家
```

### **測試案例 2: 追問更多選擇**
```
輸入: "還有其他英語補習班嗎？"
預期: 推薦教育培訓類別的所有商家
```

### **測試案例 3: 其他關鍵字追問**
```
輸入: "更多選擇" / "其他" / "另外還有什麼"
預期: 推薦教育培訓類別的所有商家
```

## 📈 監控指標

### **成功指標**
- ✅ 首次英語查詢只推薦肯塔基美語
- ✅ 追問時能提供更多教育培訓商家
- ✅ 推薦數量符合預期（首次1家，追問最多5家）
- ✅ 用戶滿意度提升

### **失敗指標**
- ❌ 首次查詢推薦過多商家
- ❌ 追問時無法提供更多選擇
- ❌ 推薦邏輯不符合用戶期望

## 🔄 版本資訊

### **版本更新**
- **版本號**: WEN 1.1.5 → WEN 1.1.6
- **建置編號**: 20250923-007 → 20250923-008
- **Git Commit**: english-recommendation-optimization
- **更新類型**: 功能優化

### **變更範圍**
- Edge Function 推薦邏輯優化
- System Prompt 規則更新
- 前端版本號更新
- 變更日誌記錄

## 🚀 部署步驟

### **Step 1: 部署 Edge Function**
```bash
# 前往 Supabase Dashboard > Edge Functions > claude-chat
# 複製 scripts/fix-recommendation-logic.ts 的全部內容
# 貼上到編輯器中
# 點擊 Deploy 按鈕
```

### **Step 2: 部署前端**
```bash
# 上傳 dist 資料夾到正式環境
# 確認版本號顯示 WEN 1.1.6
```

### **Step 3: 驗收測試**
1. 測試首次英語學習查詢
2. 測試追問更多選擇
3. 驗證推薦數量符合預期

## 🔮 後續改進

### **短期改進**
1. 優化追問關鍵字檢測
2. 增加推薦商家排序邏輯
3. 建立推薦效果監控

### **長期改進**
1. 基於用戶行為的智能推薦
2. 個性化推薦偏好學習
3. 推薦滿意度回饋機制

---

**優化負責人**: C謀
**優化日期**: 2025-09-23
**版本**: WEN 1.1.6
**狀態**: 準備部署
