# 🚨 高文文幻覺修復指南

## ❌ 問題描述

高文文出現了嚴重的「幻覺」問題：

1. **錯誤觸發英語推薦**：用戶問 "有什麼美食推薦?" 或 "有沒有在賣傢俱的"，高文文卻推薦肯塔基美語
2. **編造不存在的商家**：高文文編造了不存在的傢俱店地址和商家資訊
3. **關鍵字檢測過於寬泛**：`'推薦'` 被包含在英語關鍵字中，導致所有推薦都被誤判

## 🔍 根本原因

### 1. 英語關鍵字檢測邏輯問題
```typescript
// 問題代碼
const englishKeywords = ['英語', '美語', '補習班', '教育', '學習', '英文', '課程', '培訓', '肯塔基', '學美語', '學英語', '英文學習', '美語學習', '語言學習', '補習', '教學', '老師', '學生', '學校', '教育機構', '我想學', '想要學', '推薦', '補習班推薦'];
const isEnglishRelated = englishKeywords.some(keyword => message.includes(keyword));
```

**問題**：`'推薦'` 關鍵字太寬泛，導致 "美食推薦"、"傢俱推薦" 都被誤判為英語相關問題。

### 2. 強制推薦邏輯觸發錯誤
當檢測到英語關鍵字時，系統強制推薦肯塔基美語，但用戶問的是其他類型的推薦。

## ✅ 修復方案

### 1. 移除過於寬泛的關鍵字
```typescript
// 修復後代碼
const englishKeywords = ['英語', '美語', '補習班', '教育', '學習', '英文', '課程', '培訓', '肯塔基', '學美語', '學英語', '英文學習', '美語學習', '語言學習', '補習', '教學', '老師', '學生', '學校', '教育機構', '我想學', '想要學', '補習班推薦'];
```

**移除**：`'推薦'` 關鍵字

### 2. 添加排除條件
```typescript
// 更精確的英語相關檢測
const isEnglishRelated = englishKeywords.some(keyword => message.includes(keyword)) && 
                         !message.includes('美食') && 
                         !message.includes('餐廳') && 
                         !message.includes('傢俱') && 
                         !message.includes('家具') && 
                         !message.includes('停車') && 
                         !message.includes('購物') && 
                         !message.includes('服飾') && 
                         !message.includes('美容') && 
                         !message.includes('醫療') && 
                         !message.includes('銀行') && 
                         !message.includes('便利商店');
```

**添加**：排除非英語相關的推薦類型

## 🚀 立即修復步驟

### 步驟 1: 更新 Edge Function
1. 前往：https://supabase.com/dashboard/project/vqcuwjfxoxjgsrueqodj/functions
2. 找到 `claude-chat` 函數
3. 點擊 "程式碼" 標籤
4. 複製 `scripts/complete-edge-function-code.ts` 的內容
5. 貼到編輯器中
6. 點擊 "部署更新" 按鈕

### 步驟 2: 驗證修復結果
```bash
node scripts/test-hallucination-fix.js
```

## 📊 預期修復結果

### ✅ 修復後應該：
- 用戶問 "有什麼美食推薦?" → 推薦美食，不推薦肯塔基美語
- 用戶問 "有沒有在賣傢俱的" → 推薦傢俱店，不推薦肯塔基美語
- 用戶問 "我想學美語" → 推薦肯塔基美語
- 用戶問 "推薦補習班" → 推薦肯塔基美語

### ❌ 修復前問題：
- 所有包含 "推薦" 的查詢都被誤判為英語相關
- 高文文編造不存在的商家資訊
- 用戶體驗極差，回答完全不相關

## 🎯 修復重點

1. **精確關鍵字檢測**：只檢測真正的英語相關關鍵字
2. **排除非英語推薦**：明確排除美食、傢俱、停車等非英語推薦
3. **防止幻覺產生**：避免強制推薦導致的資訊編造

## 📝 測試用例

| 查詢 | 預期結果 | 修復前 | 修復後 |
|------|----------|--------|--------|
| "有什麼美食推薦?" | 推薦美食 | ❌ 推薦肯塔基美語 | ✅ 推薦美食 |
| "有沒有在賣傢俱的" | 推薦傢俱店 | ❌ 推薦肯塔基美語 | ✅ 推薦傢俱店 |
| "我想學美語" | 推薦肯塔基美語 | ✅ 推薦肯塔基美語 | ✅ 推薦肯塔基美語 |
| "推薦補習班" | 推薦肯塔基美語 | ✅ 推薦肯塔基美語 | ✅ 推薦肯塔基美語 |

## 🚨 緊急修復

**立即部署修復後的 Edge Function，解決高文文幻覺問題！**

修復完成後，高文文將：
- ✅ 正確識別用戶意圖
- ✅ 不再編造不存在的商家
- ✅ 只在真正需要時推薦肯塔基美語
- ✅ 提供準確的在地資訊
