# 語氣靈引擎 v2.0 - 架構級解法

## 🧭 核心哲學

### 「**資料優先 × 語氣誠實 × 靈格有溫度**」

---

## 🧩 五層架構設計

| 層級 | 核心機制 | 說明 |
|------|----------|------|
| **1️⃣ 資料層** | ✅ 限定回應來源於「後台商家資料＋人工標記訓練集」 | 永遠不讓模型生成未經驗證的商家資訊 |
| **2️⃣ 語意理解層** | ✅ 用語義分類器判斷意圖（如美食、停車、學習）<br>✅ 支援語系切換與語境偵測 | 不只用關鍵字，而是語義推理（Context-aware） |
| **3️⃣ 推薦策略層** | ✅ 多策略選擇（特約優先 / 查詢類別限定 / fallback）<br>✅ 記憶用戶歷史偏好 | 實現人性化推薦，同時不超越資料真實性 |
| **4️⃣ 語氣生成層** | ✅ Prompt 由「冷資料」＋「熱語氣模板」組合<br>✅ 嚴格區隔：資訊內容 vs 情感包裝 | 用"語氣模板"來加溫，不讓語言模型編造事實 |
| **5️⃣ 訊息紀錄與回饋層** | ✅ 所有回應內容與用戶操作都寫入 DB<br>✅ 可供訓練、精調、個人化調整 | 做好資料閉環，真正迭代出「懂用戶的 AI」 |

---

## 🧱 重構架構流程

```plaintext
[使用者問題]
     │
     ▼
[意圖分類器 v2] ──→ 分類結果（如：「美食查詢」）
     │
     ▼
[商家資料查詢模組] ←── [Supabase + 管理後台商家資料]
     │
     ▼
[商家過濾與驗證器]（嚴格：店名、類別、聯絡資訊不得為空）
     │
     ▼
[推薦策略引擎]
   ├─ 若意圖 = 美食 → 限定 category = 餐飲美食
   ├─ 若意圖 = 英語 → 限定 store_name = 肯塔基美語（非追問）
   └─ 若查無資料 → fallback / 說明「目前無相關資料」
     │
     ▼
[語氣生成模組]
   ├─ 系統 prompt = 資料 + 溫暖語氣模板
   └─ 嚴格控制模型不可編造任何不存在資訊
     │
     ▼
[Claude / GPT 回應（可切換）]
     │
     ▼
[寫入 chat_sessions + chat_messages + user_profiles]
```

---

## 🧬 語氣模板範例

### 美食推薦模板

```plaintext
你是高文文，鳳山文山特區的 AI 導遊助手，請用溫暖、親切、像在地朋友一樣的語氣回答問題。

語氣指導原則：
- 用「嘿～」、「這附近我蠻推薦的！」等親切語調
- 像朋友推薦，不要像客服回報
- 可以加一些表情符號增加溫度
- 保持熱情但不過度誇張

嚴格約束規則：
1. 你只能使用我提供的商家資料，絕對不能編造任何不存在的商家
2. 所有店名、地址、電話、營業時間都必須與提供的資料完全一致
3. 如果沒有資料，請誠實告知，但可以加一句溫暖的安慰或提議

以下是推薦清單：
1. 文山牛肉麵 [特約商家]
   類別：餐飲美食
   地址：高雄市鳳山區文衡路123號
   電話：07-7771234
   營業時間：11:00-21:00
   評分：4.7
   特色：招牌紅燒牛肉麵、湯頭濃郁

請根據上述資料，回應下列問題：
「附近有推薦的吃飯地方嗎？」
```

**期待輸出範例：**
> 嘿～這附近我蠻推薦「文山牛肉麵」喔 🍜
> 是在地人也很愛去的一家特約餐廳，招牌紅燒牛肉麵超有水準～
> 地址在文衡路123號，營業時間到晚上9點，有空不妨去看看！

---

## ✅ 原則性總結

| 原則 | 具體作法 |
|------|----------|
| **📡 資料為主，模型為輔** | 所有回應資料來源只能來自 `Supabase` 中的商家資料與人工審核欄位 |
| **🧠 解意為核，不靠猜測** | 用語義分類器或 LLM 做意圖解析，但推薦來源仍嚴守資料庫 |
| **💬 有溫度，但不誇張** | 情感語氣透過模板加溫，不由 LLM 自發生成「虛構商家」 |
| **📖 記得用戶，但不過度記憶** | 以 `session_id` 與 `external_id` 做短期記憶，可選是否啟用用戶偏好學習 |
| **🔐 錯寧願不答，也絕不亂答** | 「找不到資料」時，允許靜默＋轉為留言/引導推薦，不做硬湊回應 |

---

## 🎯 技術實現亮點

### 1. 資料驗證器 (DataValidator)
- 嚴格驗證店名、類別、聯絡資訊
- 自動清理和標準化資料格式
- 防止不完整或無效資料進入推薦流程

### 2. 意圖分類器 (IntentClassifier)
- 支援 7 大類意圖：美食、英語學習、停車、購物、美容、醫療、一般
- 語義推理而非單純關鍵字匹配
- 追問檢測機制，支援智能對話流程

### 3. 推薦策略引擎 (RecommendationStrategy)
- 意圖導向的商家查詢策略
- 特約商家優先排序
- 追問模式下的擴展推薦

### 4. 語氣模板引擎 (ToneTemplateEngine)
- 冷資料 + 熱模板的組合設計
- 不同意圖的專屬語氣風格
- 嚴格區隔資訊內容與情感包裝

### 5. 回饋記錄器 (FeedbackLogger)
- 完整的互動記錄機制
- 意圖、推薦結果、用戶反饋的全面追蹤
- 支援後續的模型優化和個人化調整

---

## 🚀 部署與使用

### 部署指令
```bash
# 1. 複製 Edge Function 代碼
cp scripts/voice-soul-engine-v2.ts supabase/functions/claude-chat/index.ts

# 2. 部署到 Supabase
supabase functions deploy claude-chat

# 3. 更新前端版本號
npm run build
```

### 測試驗證
```bash
# 測試美食推薦
npm run test:food

# 測試英語學習推薦
npm run test:english

# 測試停車場查詢
npm run test:parking
```

---

## 🔮 未來擴展方向

### 多模型支援
- 支援 Claude、GPT-4、本地模型切換
- 模型性能監控和自動切換機制

### 個人化推薦
- 基於用戶歷史偏好的推薦調整
- 長期學習和適應機制

### 多語言支援
- 中文、英文、台語等多語言語境
- 文化適應的語氣調整

### 實時學習
- 用戶反饋的即時整合
- A/B 測試和效果評估

---

**語氣靈引擎 v2.0 實現了真正的「有溫度的 AI」，在嚴守資料真實性的前提下，展現出人性化的互動體驗。**
