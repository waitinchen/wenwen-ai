# 高文文智能客服系統 - 更版檢查清單 (WEN 1.0.4)

## 📋 更版資訊
- **版本號**: WEN 1.0.4
- **建構號**: 20250922-173932
- **發布日期**: 2025-09-22
- **主要功能**: 前台對話完整保存功能實施

## 🎯 本次更版重點

### 1. 前台對話完整保存功能
- ✅ 新增 `user_profiles` 表支援前台匿名用戶
- ✅ 更新 `chat_sessions` 和 `chat_messages` 表結構
- ✅ 實施完整的前後端 API 契約
- ✅ 更新聊天界面支援用戶資料保存
- ✅ 更新後台對話歷史管理顯示用戶資訊

### 2. 資料庫結構更新
- ✅ 新增用戶資料表 (`user_profiles`)
- ✅ 更新會話表結構 (新增 `user_id`, `last_message_preview`)
- ✅ 更新訊息表結構 (重新命名欄位)
- ✅ 建立完整索引優化查詢效能

### 3. API 功能增強
- ✅ 統一聊天 API 契約格式
- ✅ 支援 Idempotency-Key 防重送
- ✅ 完整用戶資料處理流程
- ✅ 會話摘要自動更新

## 🚀 部署步驟

### 步驟 1: 資料庫遷移
```bash
# 執行資料庫結構更新
npm run migrate:chat
```

### 步驟 2: 部署後端 API
```bash
# 部署 Supabase Edge Function
supabase functions deploy chat-message
```

### 步驟 3: 部署前端
```bash
# 建構已完成，上傳 dist 資料夾到伺服器
# 或使用現有的部署流程
```

### 步驟 4: 驗收測試
```bash
# 執行完整驗收測試
npm run test:chat-persistence
```

## 🧪 驗收清單

### 前台功能驗收
- [ ] 新開瀏覽器無痕 → 設暱稱與頭像 → 發 1 句話
- [ ] 後台列表要看到：暱稱、頭像、最後一句
- [ ] 連續發 3 句話（同 session）
- [ ] 後台該會話 `message_count = 3`
- [ ] 換裝置（不同 external_id）
- [ ] 另開新會話，後台兩筆會話各自有各自的暱稱/頭像
- [ ] 重新整理頁面後再講話（同 cookie）
- [ ] 不會新開會話，仍然追加到原會話

### 後台管理驗收
- [ ] 對話歷史管理頁面正常載入
- [ ] 會話列表顯示用戶暱稱和頭像
- [ ] 會話詳情頁面顯示完整對話歷史
- [ ] 用戶資料正確關聯和顯示

### 系統功能驗收
- [ ] 高文文自動驗收測試通過 (100%)
- [ ] 資料驗證通過 (100%)
- [ ] 建構成功無錯誤
- [ ] 所有 API 端點正常運作

## 📊 技術規格

### 資料庫變更
- 新增表: `user_profiles`
- 更新表: `chat_sessions`, `chat_messages`
- 新增索引: 用戶資料、會話、訊息相關索引

### API 變更
- 新增端點: `/api/chat/message`
- 更新格式: 統一請求/回應格式
- 新增功能: 用戶資料管理、會話摘要

### 前端變更
- 新增檔案: `src/lib/chatApi.ts`
- 更新組件: `ChatInterface.tsx`, `ConversationHistoryManager.tsx`
- 新增功能: 用戶資料保存、會話歷史載入

## 🔧 故障排除

### 常見問題
1. **後台顯示 "unknown-client"**
   - 檢查前端是否正確傳送 `user_meta`
   - 確認 `display_name` 和 `avatar_url` 有值

2. **每次都被當新會話**
   - 檢查 `session_id` 是否正確回存
   - 確認 Cookie 設定正確

3. **後台列表看不到用戶資料**
   - 檢查查詢是否正確 JOIN `user_profiles`
   - 確認資料庫遷移是否完成

4. **建構失敗**
   - 檢查 TypeScript 編譯錯誤
   - 確認所有依賴已安裝

### 回滾方案
如果部署後發現問題，可以：
1. 回滾到上一個穩定版本
2. 修復問題後重新部署
3. 使用資料庫備份恢復

## 📈 監控指標

### 功能指標
- 用戶資料完整率: 目標 ≥ 95%
- 會話連續性: 目標 ≥ 90%
- 資料一致性: 目標 100%

### 效能指標
- 頁面載入時間: 目標 < 3 秒
- API 回應時間: 目標 < 2 秒
- 資料庫查詢效能: 目標 < 500ms

## ✅ 部署確認

### 部署前檢查
- [ ] 所有測試通過
- [ ] 建構成功
- [ ] 資料庫遷移腳本準備就緒
- [ ] 備份資料庫
- [ ] 通知相關人員

### 部署後檢查
- [ ] 前台功能正常
- [ ] 後台管理正常
- [ ] 資料庫查詢正常
- [ ] 監控指標正常
- [ ] 用戶回饋正常

## 🎉 更版完成

**WEN 1.0.4 更版準備完成！**

- ✅ 程式碼已提交並推送
- ✅ 建構成功無錯誤
- ✅ 驗收測試通過
- ✅ 部署檢查清單準備完成

**準備部署到正式環境！** 🚀
